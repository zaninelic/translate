<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Versionador de Pipes</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; padding: 16px; background: #fafbfc; color: #333; font-size: 13px; }
    h2 { font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .tabs { display: flex; border-bottom: 2px solid #e0e6ed; margin-bottom: 16px; }
    .tab { padding: 8px 14px; font-size: 11px; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; color: #666; transition: all 0.15s; }
    .tab:hover { color: #333; }
    .tab.active { color: #2196f3; border-bottom-color: #2196f3; }
    .loading { text-align: center; padding: 32px; color: #999; }
    .loading .spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid #e0e6ed; border-top: 3px solid #2196f3; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-box { background: #ffebee; border: 1px solid #ef9a9a; border-radius: 6px; padding: 12px; margin-bottom: 12px; color: #c62828; font-size: 12px; }
    .info-box { background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 0 6px 6px 0; padding: 12px; margin-bottom: 12px; font-size: 12px; }
    .success-box { background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 6px; padding: 12px; margin-bottom: 12px; color: #2e7d32; font-size: 12px; }
    .version-card { background: #fff; border: 1px solid #e0e6ed; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; }
    .version-card:hover { border-color: #2196f3; box-shadow: 0 2px 8px rgba(33,150,243,0.1); }
    .version-card.selected { border-color: #2196f3; background: #e3f2fd; }
    .version-header { display: flex; justify-content: space-between; align-items: center; }
    .version-label { font-weight: 700; font-size: 13px; }
    .version-badge { font-size: 10px; padding: 2px 8px; border-radius: 12px; font-weight: 600; text-transform: uppercase; }
    .badge-draft { background: #fff3e0; color: #e65100; }
    .badge-published { background: #e8f5e9; color: #2e7d32; }
    .badge-approved { background: #e3f2fd; color: #1565c0; }
    .badge-pending_approval { background: #f3e5f5; color: #7b1fa2; }
    .badge-pre_publish_backup { background: #fce4ec; color: #c62828; }
    .version-meta { font-size: 11px; color: #999; margin-top: 4px; }
    .version-summary { font-size: 12px; color: #666; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #eee; }
    .compare-select { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; margin-bottom: 12px; }
    .compare-select select { width: 100%; padding: 6px; border: 1px solid #e0e6ed; border-radius: 4px; font-size: 11px; }
    .compare-select .arrow { text-align: center; font-size: 16px; }
    .diff-section { background: #fff; border: 1px solid #e0e6ed; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .diff-title { font-weight: 600; font-size: 13px; margin-bottom: 8px; }
    .diff-item { font-size: 12px; padding: 4px 8px; margin: 2px 0; border-radius: 4px; }
    .diff-add { background: #e8f5e9; color: #2e7d32; }
    .diff-remove { background: #ffebee; color: #c62828; }
    .actions { display: flex; gap: 8px; margin-top: 16px; }
    .btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: 600; font-size: 11px; cursor: pointer; transition: all 0.15s; }
    .btn:hover { opacity: 0.85; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #2196f3; color: white; }
    .btn-success { background: #4caf50; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .empty { text-align: center; padding: 32px; color: #999; font-size: 12px; }
    .panel { display: none; }
    .panel.active { display: block; }
  </style>
</head>
<body>
  <h2>üîÑ Versionador</h2>

  <div id="error-container"></div>

  <div class="tabs">
    <div class="tab active" data-tab="versions">Vers√µes</div>
    <div class="tab" data-tab="compare">Comparar</div>
  </div>

  <div id="panel-versions" class="panel active">
    <div id="versions-loading" class="loading"><div class="spinner"></div><p>Carregando vers√µes...</p></div>
    <div id="versions-list" style="display:none;"></div>
    <div id="versions-empty" class="empty" style="display:none;">
      Nenhuma vers√£o encontrada.<br/>Crie um snapshot para come√ßar.
    </div>
  </div>

  <div id="panel-compare" class="panel">
    <div class="compare-select">
      <select id="compare-from"><option value="">Vers√£o base</option></select>
      <div class="arrow">‚Üí</div>
      <select id="compare-to"><option value="">Vers√£o alvo</option></select>
    </div>
    <button class="btn btn-primary" onclick="runCompare()" style="width:100%; margin-bottom:12px;">Comparar</button>
    <div id="compare-result"></div>
  </div>

  <div class="actions">
    <button class="btn btn-primary" onclick="openSnapshot()">üì∏ Snapshot</button>
    <button class="btn btn-danger" id="btn-rollback" onclick="runRollback()" disabled>‚Ü©Ô∏è Rollback</button>
  </div>

  <div id="feedback" style="margin-top:12px;"></div>

  <script>
    var SUPABASE_URL = 'https://iervmwscvspisxbktbpx.supabase.co';
    var API_URL = SUPABASE_URL + '/functions/v1/versioner-sidebar';
    var SNAPSHOT_PAGE = 'https://zaninelic.github.io/pipefy-versioner/snapshot.html';

    var params = new URLSearchParams(window.location.search);
    var PIPE_ID = params.get('pipeId') || '';
    var versions = [];
    var selectedVersionId = null;

    // Tab switching
    document.querySelectorAll('.tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
      });
    });

    function renderVersions() {
      var list = document.getElementById('versions-list');
      var empty = document.getElementById('versions-empty');
      var loading = document.getElementById('versions-loading');
      loading.style.display = 'none';

      if (versions.length === 0) {
        empty.style.display = 'block';
        list.style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      list.style.display = 'block';

      list.innerHTML = versions.map(function(v) {
        var badgeClass = 'badge-' + (v.status || 'draft');
        var isSelected = v.id === selectedVersionId;
        var date = new Date(v.created_at).toLocaleDateString('pt-BR');
        var trigger = v.trigger_type === 'pre_publish_backup' ? 'ü§ñ Auto' : 'üë§ Manual';
        return '<div class="version-card' + (isSelected ? ' selected' : '') + '" onclick="selectVersion(\'' + v.id + '\')">'
          + '<div class="version-header">'
          + '<span class="version-label">v' + v.version + (v.version_label ? ' ‚Äî ' + v.version_label : '') + '</span>'
          + '<span class="version-badge ' + badgeClass + '">' + v.status + '</span>'
          + '</div>'
          + '<div class="version-meta">üìÖ ' + date + ' ‚Ä¢ ' + trigger + '</div>'
          + (v.change_summary ? '<div class="version-summary">' + v.change_summary + '</div>' : '')
          + '</div>';
      }).join('');

      var opts = versions.map(function(v) { return '<option value="' + v.id + '">v' + v.version + (v.version_label ? ' - ' + v.version_label : '') + '</option>'; }).join('');
      document.getElementById('compare-from').innerHTML = '<option value="">Vers√£o base</option>' + opts;
      document.getElementById('compare-to').innerHTML = '<option value="">Vers√£o alvo</option>' + opts;
    }

    function selectVersion(id) {
      selectedVersionId = id;
      document.getElementById('btn-rollback').disabled = false;
      renderVersions();
    }

    function showFeedback(msg, type) {
      var el = document.getElementById('feedback');
      var cls = type === 'error' ? 'error-box' : type === 'success' ? 'success-box' : 'info-box';
      el.innerHTML = '<div class="' + cls + '">' + msg + '</div>';
      setTimeout(function() { el.innerHTML = ''; }, 8000);
    }

    function openSnapshot() {
      window.location.href = SNAPSHOT_PAGE + '?pipeId=' + encodeURIComponent(PIPE_ID);
    }

    async function loadVersions() {
      if (!PIPE_ID) {
        document.getElementById('error-container').innerHTML = '<div class="error-box">‚ö†Ô∏è Pipe ID n√£o detectado. Abra o versionador a partir de um pipe.</div>';
        document.getElementById('versions-loading').style.display = 'none';
        return;
      }
      try {
        var res = await fetch(API_URL + '?pipeId=' + encodeURIComponent(PIPE_ID) + '&action=list', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
        });
        var data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erro ao carregar vers√µes');
        versions = data.versions || [];
        renderVersions();
      } catch(e) {
        document.getElementById('versions-loading').innerHTML = '<div class="error-box">‚ùå ' + e.message + '</div>';
      }
    }

    async function runCompare() {
      var fromId = document.getElementById('compare-from').value;
      var toId = document.getElementById('compare-to').value;
      if (!fromId || !toId) { alert('Selecione duas vers√µes'); return; }
      document.getElementById('compare-result').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      try {
        var res = await fetch(API_URL + '?action=compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fromId: fromId, toId: toId }),
        });
        var result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Erro ao comparar');
        renderDiff(result);
      } catch(e) {
        document.getElementById('compare-result').innerHTML = '<div class="error-box">' + e.message + '</div>';
      }
    }

    function renderDiff(result) {
      var container = document.getElementById('compare-result');
      if (!result || !result.diff) {
        container.innerHTML = '<div class="info-box">Nenhuma diferen√ßa encontrada.</div>';
        return;
      }
      var html = '<div class="info-box">v' + result.from.version + ' ‚Üí v' + result.to.version + '</div>';
      var diff = result.diff;
      if (diff.phases && (diff.phases.added.length || diff.phases.removed.length)) {
        html += '<div class="diff-section"><div class="diff-title">üìã Fases</div>';
        diff.phases.added.forEach(function(p) { html += '<div class="diff-item diff-add">+ ' + p + '</div>'; });
        diff.phases.removed.forEach(function(p) { html += '<div class="diff-item diff-remove">- ' + p + '</div>'; });
        html += '</div>';
      }
      if (diff.fields && (diff.fields.added.length || diff.fields.removed.length)) {
        html += '<div class="diff-section"><div class="diff-title">üè∑Ô∏è Campos</div>';
        diff.fields.added.forEach(function(f) { html += '<div class="diff-item diff-add">+ ' + f + '</div>'; });
        diff.fields.removed.forEach(function(f) { html += '<div class="diff-item diff-remove">- ' + f + '</div>'; });
        html += '</div>';
      }
      if (diff.labels && (diff.labels.added.length || diff.labels.removed.length)) {
        html += '<div class="diff-section"><div class="diff-title">üè∑Ô∏è Etiquetas</div>';
        diff.labels.added.forEach(function(l) { html += '<div class="diff-item diff-add">+ ' + l + '</div>'; });
        diff.labels.removed.forEach(function(l) { html += '<div class="diff-item diff-remove">- ' + l + '</div>'; });
        html += '</div>';
      }
      container.innerHTML = html || '<div class="info-box">Schemas id√™nticos.</div>';
    }

    async function runRollback() {
      if (!selectedVersionId) return;
      if (!confirm('Tem certeza que deseja restaurar esta vers√£o?')) return;
      try {
        var res = await fetch(API_URL + '?action=rollback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ versionId: selectedVersionId }),
        });
        var result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Erro no rollback');
        showFeedback('‚úÖ Vers√£o preparada para rollback!', 'success');
      } catch(e) {
        showFeedback('‚ùå ' + e.message, 'error');
      }
    }

    loadVersions();
  </script>
</body>
</html>
